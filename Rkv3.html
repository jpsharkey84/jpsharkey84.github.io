<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Beacon Master OS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root { --bg-top:#0b1d33; --panel-bg:#91c2f0b9; --panel-border:rgba(255,255,255,0.55); --text-main:#ffffff; }
        body { margin:0; height:100vh; font-family:"Trebuchet MS",Verdana,sans-serif; color:var(--text-main); background:#000; overflow:hidden; }
        #canvas-container { position:absolute; top:0; left:0; width:100%; height:100%; z-index:1; }
        #app { display:grid; grid-template-columns:240px 1fr; height:100vh; position:relative; z-index:10; pointer-events:none; }
        
        /* MENU */
        #menu { background:var(--panel-bg); border-right:1px solid var(--panel-border); padding:20px 14px; pointer-events:auto; }
        .menu-item { padding:10px 8px; margin-bottom:6px; cursor:pointer; border-left:4px solid transparent; transition:0.3s; }
        .menu-item:hover { background:rgba(255,255,255,0.15); border-left:4px solid white; }
        
        /* MAIN UI PANELS */
        #main { padding:24px; display:flex; flex-direction:column; justify-content:flex-start; pointer-events:none; }
        .day-panel { background:var(--panel-bg); border:1px solid var(--panel-border); border-radius:10px; padding:12px 14px; margin-top:16px; pointer-events:auto; width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        
        #beacon { align-self:flex-end; height:120px; width:120px; background:radial-gradient(circle at center,rgba(9, 255, 0, 0.6),rgba(9, 255, 0, 0.05)); box-shadow:0 0 20px rgba(0, 255, 85, 0.4); border-radius:25px; animation:breathe 6s ease-in-out infinite; margin-top:auto; }
        @keyframes breathe{1%,100%{opacity:0.55;}75%{opacity:1;}}
        
        textarea { width:95%; background:rgba(0,0,0,0.2); color:white; border:1px solid rgba(255,255,255,0.4); padding:8px; resize:none; border-radius:4px; }
        button { background:none; border:1px solid white; color:white; padding:8px 12px; cursor:pointer; border-radius:4px; margin-top:10px; }
        button:hover { background:rgba(255,255,255,0.2); }
    </style>
</head>
<body>

<div id="canvas-container"></div>

<div id="app">
    <div id="menu">
        <div style="font-size:14px; letter-spacing:2px; margin-bottom:20px; opacity:0.6;">HUB_OS</div>
        <div class="menu-item" onclick="switchTab('log')">Calendar Logs</div>
        <div class="menu-item" onclick="switchTab('backpack')">Backpack</div>
        <div class="menu-item" onclick="switchTab('map')">Spatial Map</div>
    </div>

    <div id="main">
        <div id="status" style="pointer-events:auto;">
            <div id="z-readout" style="font-weight:bold;">Z: 0.00</div>
            <div id="active-tab" style="font-size:12px; opacity:0.8;">MODE: LOG</div>
        </div>

        <div class="day-panel">
            <form id="master-form">
                <input type="hidden" name="category" id="f-category" value="log">
                <input type="hidden" name="z_coord" id="f-z">
                <textarea name="content" id="f-content" rows="4" placeholder="Input data string..."></textarea>
                <button type="submit">COMMIT TO SQL</button>
            </form>
        </div>

        <div class="day-panel" style="flex-grow:0; max-height: 250px; overflow-y: auto;">
            <div id="archive-list" style="font-size: 13px;"></div>
        </div>

        <div id="beacon"></div>
    </div>
</div>

<script>
// --- 3D ENVIRONMENT ---
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.getElementById('canvas-container').appendChild(renderer.domElement);

const grid = new THREE.GridHelper(2000, 100, 0x00ff55, 0x222222);
scene.add(grid);
camera.position.set(0, 5, 10);

const keys = {};
window.onkeydown = e => keys[e.key.toLowerCase()] = true;
window.onkeyup = e => keys[e.key.toLowerCase()] = false;

function animate() {
    requestAnimationFrame(animate);
    if(keys['w']) camera.position.z -= 0.5;
    if(keys['s']) camera.position.z += 0.5;
    document.getElementById('z-readout').innerText = `Z: ${camera.position.z.toFixed(2)}`;
    document.getElementById('f-z').value = camera.position.z;
    renderer.render(scene, camera);
}
animate();

// --- DATA LOGIC ---
async function switchTab(cat) {
    document.getElementById('f-category').value = cat;
    document.getElementById('active-tab').innerText = `MODE: ${cat.toUpperCase()}`;
    loadFromSQL(cat);
}

async function loadFromSQL(cat) {
    const resp = await fetch(`/api/load/${cat}`);
    const data = await resp.json();
    const list = document.getElementById('archive-list');
    list.innerHTML = data.map(i => `<div style="border-bottom:1px solid rgba(255,255,255,0.1); padding:5px;">[Z: ${i.z.toFixed(1)}] ${i.content}</div>`).join('');
}

document.getElementById('master-form').onsubmit = async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const resp = await fetch('/api/sync', { method: 'POST', body: fd });
    if(resp.ok) {
        document.getElementById('f-content').value = '';
        loadFromSQL(document.getElementById('f-category').value);
        // Beacon Flash
        const b = document.getElementById('beacon');
        b.style.boxShadow = '0 0 40px white';
        setTimeout(() => b.style.boxShadow = '0 0 20px rgba(0, 255, 85, 0.4)', 300);
    }
};

// Start
switchTab('log');
</script>
</body>
</html>
