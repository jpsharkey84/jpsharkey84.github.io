<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BEACONS | OS v1.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;500&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #94b0da; --accent: #ff9d00; --bg: #050a14; --panel-alpha: rgba(10, 20, 35, 0.9); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg); font-family: 'JetBrains Mono', monospace; color: white; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: grid; grid-template-columns: 300px 1fr 300px; grid-template-rows: 1fr 220px; padding: 30px; box-sizing: border-box; }
        .panel { pointer-events: auto; background: var(--panel-alpha); border: 1px solid rgba(148, 176, 218, 0.3); backdrop-filter: blur(12px); padding: 20px; }
        .directory { grid-column: 1; grid-row: 1; }
        .monitor { grid-column: 3; grid-row: 1; text-align: right; }
        .terminal { grid-column: 1 / span 3; grid-row: 2; margin-top: 20px; border-top: 2px solid var(--accent); display: flex; flex-direction: column; }
        #output { flex: 1; font-size: 12px; color: #8899aa; overflow-y: auto; margin-bottom: 10px; }
        .input-line { display: flex; align-items: center; }
        input { background: transparent; border: none; color: #fff; font-family: 'JetBrains Mono'; font-size: 14px; width: 100%; outline: none; }
        .stat-label { font-size: 10px; color: var(--primary); display: block; }
        .stat-value { font-size: 18px; font-weight: 500; }
        #hidden-system-form { display: none; }
    </style>
</head>
<body>

<div id="canvas-container"></div>

<form id="hidden-system-form">
    <input type="text" name="action" id="form-action">
    <input type="text" name="payload" id="form-payload">
    <input type="text" name="z_coord" id="form-z">
</form>

<div id="hud">
    <div class="panel directory">
        <h2 style="font-size:14px; color:var(--primary); border-bottom:1px solid var(--primary); padding-bottom:10px;">DOMAIN_INDEX</h2>
        <div style="font-size:12px; opacity:0.7; margin:10px 0;">ACTIVE_LOGS: {{ logs|length }}</div>
        <div style="font-size:12px; opacity:0.7; margin:10px 0;">CREDITS: {{ state.credits }}</div>
    </div>

    <div class="panel monitor">
        <div class="stat-row"><span class="stat-label">COORDINATE_Z</span><span id="stat-z" class="stat-value">0.00</span></div>
        <div class="stat-row"><span class="stat-label">SYSTEM_MOOD</span><span id="stat-mood" class="stat-value" style="color:var(--accent);">{{ state.mood }}</span></div>
    </div>

    <div class="panel terminal">
        <div id="output">[SYS] BEACONS BOOT SEQUENCE COMPLETE...<br>[SYS] DATABASE_LINKED: SUCCESS</div>
        <div class="input-line">
            <span style="color:var(--accent); margin-right:10px;">SYSTEM@ROOT:~$</span>
            <input type="text" id="cmd-input" autofocus autocomplete="off">
        </div>
    </div>
</div>

<script>
/** ENGINE START **/
class SpatialEngine {
    constructor() {
        this.scene = new THREE.Scene();
        this.scene.fog = new THREE.FogExp2(0x0a1423, 0.008);
        this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000);
        this.renderer = new THREE.WebGLRenderer({ antialias: true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(this.renderer.domElement);
        
        const sun = new THREE.DirectionalLight(0xff9d00, 1.5);
        sun.position.set(0, 50, -100);
        this.scene.add(sun);
        this.scene.add(new THREE.AmbientLight(0x404040));

        const grid = new THREE.Mesh(new THREE.PlaneGeometry(40, 2000), new THREE.MeshPhongMaterial({color: 0x94b0da, wireframe:true, transparent:true, opacity:0.1}));
        grid.rotation.x = -Math.PI/2;
        this.scene.add(grid);

        this.spires = [];
        this.animate();
    }

    spawnSpire(z) {
        const height = 40 + Math.random() * 30;
        const mesh = new THREE.Mesh(
            new THREE.CylinderGeometry(0, 3, height, 4),
            new THREE.MeshPhongMaterial({color: 0xffffff, emissive: 0x4a6fa5, transparent:true, opacity:0.6})
        );
        mesh.position.set(Math.random() > 0.5 ? 25 : -25, height/2, z);
        this.scene.add(mesh);
    }

    animate() {
        requestAnimationFrame(() => this.animate());
        if(keys['KeyW']) this.camera.position.z -= 0.5;
        if(keys['KeyS']) this.camera.position.z += 0.5;
        document.getElementById('stat-z').innerText = Math.abs(this.camera.position.z).toFixed(2);
        this.renderer.render(this.scene, this.camera);
    }
}

/** SYSTEM START **/
class BeaconsSystem {
    constructor() {
        this.initTerminal();
        // Load existing logs from DB on startup
        {% for log in logs %}
        setTimeout(() => engine.spawnSpire({{ log.z_pos }}), 100);
        {% endfor %}
    }

    initTerminal() {
        const input = document.getElementById('cmd-input');
        input.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const val = input.value;
                input.value = '';
                await this.processCommand(val);
            }
        });
    }

    async processCommand(cmd) {
        const [action, ...rest] = cmd.toLowerCase().split(' ');
        const payload = rest.join(' ');

        // Map to Form
        document.getElementById('form-action').value = action;
        document.getElementById('form-payload').value = payload;
        document.getElementById('form-z').value = engine.camera.position.z - 50;

        const formData = new FormData(document.getElementById('hidden-system-form'));

        try {
            const response = await fetch('/sync', { method: 'POST', body: formData });
            const data = await response.json();

            if(data.type === 'log') {
                this.log(`RECORDED TO SQL: ${data.payload}`, 'DATA');
                engine.spawnSpire(engine.camera.position.z - 50);
            } else if (data.type === 'mood') {
                this.log(`ENV SHIFT: ${data.payload}`);
                document.getElementById('stat-mood').innerText = data.payload;
            }
        } catch (e) {
            this.log("POST_FAILED: DATABASE_OFFLINE", "ERR");
        }
    }

    log(msg, type='SYS') {
        const out = document.getElementById('output');
        out.innerHTML += `<br>[${type}] ${msg}`;
        out.scrollTop = out.scrollHeight;
    }
}

const keys = {};
window.onkeydown = e => keys[e.code] = true;
window.onkeyup = e => keys[e.code] = false;

const engine = new SpatialEngine();
const sys = new BeaconsSystem();
</script>
</body>
</html>
