<script>
class BeaconsSystem {
    constructor() {
        // Data injected from Flask on load
        this.state = {
            mood: "{{ state.mood }}",
            money: {{ state.credits }},
            startTime: Date.now()
        };
        this.initTerminal();
        this.updateClock();
        
        // Render existing logs from DB on boot
        {% for log in logs %}
        setTimeout(() => engine.spawnSpire({{ log.z_pos }}), 500);
        {% endfor %}
    }

    async execute(cmd) {
        const parts = cmd.toLowerCase().split(' ');
        const action = parts[0];
        const payload = cmd.substring(action.length + 1);

        try {
            const response = await fetch('/api/command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: action,
                    payload: payload,
                    z_pos: engine.camera.position.z - 50
                })
            });

            const data = await response.json();

            if (data.status === 'recorded') {
                this.log(`SQL_SYNC: "${data.msg}"`, 'DB');
                engine.spawnSpire(engine.camera.position.z - 50);
            } else if (data.status === 'environment_shifted') {
                this.state.mood = data.mood;
                document.getElementById('stat-mood').innerText = data.mood;
                this.log(`SYSTEM_MOOD_UPDATED: ${data.mood}`);
            } else {
                this.log(`ERR: ${data.msg || 'CMD_FAILED'}`, 'FAIL');
            }
        } catch (err) {
            this.log("CONNECTION_LOST: DATABASE_OFFLINE", "ERR");
        }
    }

    log(msg, type = 'SYS') {
        const out = document.getElementById('output');
        out.innerHTML += `<br>[${type}] ${msg}`;
        out.scrollTop = out.scrollHeight;
    }

    // ... (Keep initTerminal and updateClock as is)
}
</script>
from flask import Flask, render_template, request, jsonify
from flask_sqlalchemy import SQLAlchemy
import os

app = Flask(__name__)
# Creates beacons.db in your project folder
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///beacons.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
db = SQLAlchemy(app)

# SQL STRUCTURE
class SystemState(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    credits = db.Column(db.Integer, default=1000)
    mood = db.Column(db.String(50), default='ORANGE_FLOW')

class LogEntry(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    content = db.Column(db.String(255))
    z_pos = db.Column(db.Float)

@app.route('/')
def index():
    state = SystemState.query.first()
    logs = LogEntry.query.all()
    return render_template('index.html', state=state, logs=logs)

@app.route('/api/command', methods=['POST'])
def handle_command():
    data = request.json
    action = data.get('type')
    payload = data.get('payload')

    if action == 'log':
        new_entry = LogEntry(content=payload, z_pos=data.get('z_pos'))
        db.session.add(new_entry)
        db.session.commit()
        return jsonify({"status": "recorded", "msg": payload})

    if action == 'mood':
        state = SystemState.query.first()
        state.mood = payload.upper()
        db.session.commit()
        return jsonify({"status": "environment_shifted", "mood": state.mood})

    return jsonify({"status": "error", "msg": "invalid_command"}), 400

if __name__ == '__main__':
    with app.app_context():
        db.create_all()
        if not SystemState.query.first():
            db.session.add(SystemState(credits=1000, mood='ORANGE_FLOW'))
            db.session.commit()
    app.run(debug=True, port=5000)
